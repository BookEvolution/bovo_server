name: Deploy to EC2

on:
  push:
    branches: [ feature/pjc_clean ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ 
        uses: actions/checkout@v3

      - name: â˜•ï¸ Java 23 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: ðŸ›  Gradle ë¹Œë“œ
        run: ./gradlew clean build -x test

      - name: ðŸ“ ë¹Œë“œ ê²°ê³¼ í™•ì¸
        run: ls -al build/libs

      - name: ðŸ“¦ EC2ì— jar ë³µì‚¬
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: build/libs/${{ secrets.JAR_NAME }}
          target: /home/ubuntu/app/

      - name: ðŸš€ EC2ì—ì„œ ì„œë²„ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            ls
            pwd
            echo "ðŸ” í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ í™•ì¸"
            JAR=${{ secrets.JAR_NAME }}
            echo "$JAR"
            PID=$(ps -ef | grep "$JAR" | grep -v grep | awk '{print $2}')
            if [ -n "$PID" ]; then
              echo "âš ï¸ ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: $PID"
              kill -9 $PID
            else
              echo "âœ… ì¢…ë£Œí•  ì„œë²„ ì—†ìŒ"
            fi

            
            echo "ðŸš€ ìƒˆ ì„œë²„ ì‹¤í–‰"
            nohup java -jar \
              -Dspring.config.location=file:/home/ubuntu/app/config/ \
              -Dspring.profiles.active=prod \
              /home/ubuntu/app/build/libs/$JAR \
              > /home/ubuntu/app/build/libs/log.txt 2>&1 &

            sleep 5

            echo "ðŸ“„ ì„œë²„ ë¡œê·¸ ì¶œë ¥ ì‹œìž‘ (log.txt)"
            tail -n 100 /home/ubuntu/app/build/libs/log.txt

